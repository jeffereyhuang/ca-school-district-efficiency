---
title: "Growth Measures"
author: "Jeff Huang"
date: "7/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)

growth_data <- read.csv("data/CA_SEDA_long.csv") 

clean_growth <- growth_data %>% 
  mutate(cohort = year - grade) %>% 
  select(leaidC, leaname, grade, year, subject, mn_all, cohort)

```

```{r density distribution}

# EDA
for (i in 3:8) {
  data = subset(clean_growth, grade == i)
  print(ggplot(data, aes(mn_all, color = subject)) +
  geom_density() + 
  labs(title = paste("Distribution of students in grade", i, sep = " ")) + 
  scale_x_continuous(name = "Achievement Level",
                           breaks = 0:15,
                           limits=c(0, 15)))
}

```


```{r function definition}

# 1 year of data

cohort_3_8 <- clean_growth %>% 
  select(-year) %>% 
  filter(cohort == 2007) %>% 
  filter(grade %in% c(3, 8)) %>% 
  spread(grade, mn_all) %>% 
  drop_na(`3`, `8`) %>% 
  mutate(growth = `8`-`3`) %>% 
  drop_na(growth) %>% 
  select(leaidC, leaname, cohort, subject, growth) %>% 
  spread(subject, growth) %>%
  group_by(leaidC, leaname) %>% 
  mutate(combined_38_growth = mean(c(ela, math), na.rm = TRUE))


# 4 years of data

cohort_3_5 <- clean_growth %>% 
  select(-year) %>% 
  filter(cohort %in% c(2006:2010)) %>% 
  filter(grade %in% c(3, 5)) %>% 
  spread(grade, mn_all) %>% 
  drop_na(`3`, `5`) %>% 
  mutate(growth = `5`-`3`) %>% 
  drop_na(growth) %>% 
  select(leaidC, leaname, cohort, subject, growth) %>% 
  spread(subject, growth) %>%
  group_by(leaidC, leaname) %>% 
  mutate(ela_avg = mean(ela), math_avg = mean(math)) %>% 
  mutate(combined_35_growth = mean(c(ela_avg, math_avg), na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(leaidC, leaname, cohort) %>% 
  mutate(yearly_jump = mean(c(math, ela), na.rm = TRUE))

# one year of data
cohort_6_8 <- clean_growth %>% 
  select(-year) %>% 
  filter(cohort == 2007) %>%
  filter(grade %in% c(6, 8)) %>% 
  spread(grade, mn_all) %>% 
  mutate(growth = `8`-`6`) %>% 
  drop_na() %>% 
  select(leaidC, leaname, cohort, subject, growth) %>% 
  spread(subject, growth) %>%
  group_by(leaidC, leaname) %>% 
  mutate(ela = mean(ela), math = mean(math)) %>% 
  mutate(combined_68_growth = mean(c(ela, math), na.rm = TRUE))




# sanity check, what if the grade is just really smart?
# sanity check, big jumps to measure leaving? good teacher?
  # use the standardized dataset for this (this is standardized relative to distr. for cohort)

# then merge w other group, and do rf on efficiency - & on gaps

# large jumps, large 

```

```{r sanity check graphs}

# scatter of english vs math
ggplot(cohort_3_5) + 
  geom_point(aes(x=math_avg, y=ela_avg))

ggplot(cohort_6_8) + 
  geom_point(aes(x=math, y=ela))

ggplot(cohort_3_8) + 
  geom_point(aes(x=math, y=ela))

# density of district growth

ggplot(cohort_3_5) +
  geom_density(aes(x=combined_35_growth))

ggplot(cohort_6_8) +
  geom_density(aes(x=combined_68_growth))

ggplot(cohort_3_8) +
  geom_density(aes(x=combined_38_growth))


# additional cohort analysis

# more data points for ela vs math growth
ggplot(cohort_3_5) + 
  geom_point(aes(x=math, y=ela))

ggplot(cohort_3_5) + 
  geom_density(aes(x=math)) + 
  geom_density(aes(x=ela))


# prevalence of large spikes 

big_jumps <- cohort_3_5 %>% 
  mutate(relative_spike = yearly_jump - combined_35_growth)

ggplot(big_jumps) +
  geom_point(aes(x=combined_35_growth, y=yearly_jump))

ggplot(big_jumps) +
  geom_density(aes(x=relative_spike))


```


