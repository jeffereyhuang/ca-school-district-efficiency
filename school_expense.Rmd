---
title: "School Expenses"
author: "Jeff Huang"
date: "4/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(janitor)
library(ggplot2)
library(gt)
library(reshape2)
library(ggthemes)
```

```{r download, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

# SAT download data

sat16 <- read_xls("data/sat16.xls") %>% 
  clean_names() %>% 
  select(-year)
sat15 <- read_xls("data/sat15.xls") %>% 
  clean_names()

# ACT download data

act18 <- read_xls("data/act18.xls") %>% 
  clean_names() %>% 
  mutate_at(9:14, as.integer) %>% 
  select(-year)
act17 <- read_xls("data/act17.xls") %>% 
  clean_names() %>% 
  mutate_at(9:14, as.integer)
act16 <- read_xls("data/act16.xls") %>% 
  clean_names() %>% 
  mutate_at(6:11, as.integer)
act15 <- read_xls("data/act15.xls") %>% 
  clean_names() %>% 
  mutate_at(6:11, as.integer) %>% 
  select(-year)

# AP scores download data

ap18 <- read_xls("data/ap18.xls") %>% 
  clean_names() %>% 
  select(-year) %>% 
  mutate_at(9:16, as.integer)

ap17 <- read_xls("data/ap17.xls") %>% 
  clean_names() %>% 
  mutate_at(9:16, as.integer)

ap16 <- read_xls("data/ap16.xls") %>% 
  clean_names() %>% 
  select(-year) %>% 
  mutate_at(6:13, as.integer)
ap15 <- read_xls("data/ap15.xls") %>% 
  clean_names() %>% 
  select(-year) %>% 
  mutate_at(6:13, as.integer)

# per district expenses data â€” clean data to merge later

expense18 <- read_xlsx("data/expense18.xlsx",
                       skip = 10) %>% 
  mutate(CDS = as.character(CDS)) %>% 
  clean_names()
expense17 <- read_xlsx("data/expense17.xlsx",
                       skip = 8) %>% 
  clean_names()
expense16 <- read_xls("data/expense16.xls", 
                      skip = 7) %>% 
  clean_names
expense15 <- read_xls("data/expense15.xls",
                      skip = 7) %>% 
  clean_names() %>% 
  rename(edp_365 = expenditures_edp_365) 



# Teacher Pay
# teacher stats of most efficient school districts
# $61-74K - avg teacher salary

carmel <- read_csv("data/carmel-2015.csv") %>% 
  clean_names() %>% 
  filter(job_title == "Teacher")

mend <- read_csv("data/mendocino-unified-2017.csv") %>% 
  clean_names() %>% 
  filter(job_title == "Hs Teacher")
  
pc <- read_csv("data/pc-2016.csv") %>% 
  clean_names() %>% 
  filter(str_detect(tolower(job_title), "teacher"))


# frlunch - get free reduced lunch %  and enrollments and district code

frlunch <- read_xlsx("frlunch1819.xlsx", skip=1) %>% 
  clean_names()

# staffdemo - teacher/student ratio, teachers with advanced degrees, age, years teaching, years_in_district


staff <- read_tsv("StaffDemo17.txt") %>% 
  clean_names()


```


```{r}

# Cleaning data for most efficient schools

carmel_tsal <- carmel %>% 
  rename(District = agency) %>% 
  group_by(District) %>% 
  summarize(total = mean(total_pay_benefits), base = mean(base_pay))

mend_tsal <- mend %>% 
  rename(District = agency) %>% 
  group_by(District) %>% 
  summarize(total = mean(total_pay_benefits), base = mean(base_pay))

pc_tsal <- pc %>% 
  rename(District = agency) %>% 
  group_by(District) %>% 
  summarize(total = mean(total_pay_benefits), base = mean(base_pay))

addtl_schools <- bind_rows(carmel_tsal, mend_tsal, pc_tsal)


# free and reduced lunch

frlunch_rate <- frlunch %>% 
  mutate(district_code = paste(county_code, district_code, sep="")) %>% 
  group_by(district_code) %>% 
  summarize(free_count = sum(free_meal_count_k_12), frpm_count = sum(frpm_count_k_12), enrollment = sum(enrollment_k_12)) %>% 
  mutate(free_rate = free_count/enrollment, frpm_rate = frpm_count/enrollment) %>% 
  select(district_code, enrollment, free_rate, frpm_rate)
  
# staff demographic info

total <- staff %>% 
  group_by(district_code) %>% 
  mutate(total = n()) %>% 
  select(1:5, 17)

staff_edu <- staff %>% 
  group_by(district_code, education_level) %>% 
  summarize(count = n()) %>% 
  spread(key=education_level, value=count) %>% 
  ungroup()
  
new_staff <- left_join(total, staff_edu, by="district_code") %>% 
  distinct(district_code, .keep_all=TRUE) 

n_edu_staff <- new_staff %>% 
  mutate(bachelor = B+C, doctor = D, master = M + V, bach_per = bachelor / total, doc_per = D / total, mast_per = master/total) %>% 
  select(district_code, county_name, district_name, bachelor, doctor, master, bach_per, doc_per, mast_per) 

# staff characteristics

count_teach <- staff %>% 
  filter(fte_teaching > 60) %>% 
  group_by(district_code) %>% 
  summarize(teacher = n())

count_admin <- staff %>% 
  filter(fte_administrative > 40) %>% 
  group_by(district_code) %>% 
  summarize(admin = n())

add_staff <- staff %>% 
  select(district_code, county_name, 
       district_name, age, education_level, 
       years_teaching, years_in_district, fte_teaching, fte_administrative, fte_pupil_services) %>% 
  group_by(district_code) %>% 
  summarize(avg_t_age = mean(age), t_exp = mean(years_teaching), dist_exp = mean(years_in_district), num_staff = n()) %>% 
  full_join(count_admin, by="district_code") %>% 
  full_join(count_teach, by="district_code")





# full staff addtl info

full_staff <- full_join(n_edu_staff, add_staff, by="district_code") %>% 
  full_join(frlunch_rate, b="district_code")





# merge SAT dataset

full_sat <- bind_rows(sat15, sat16, .id="year")
full_sat[, 7:11] <- sapply(full_sat[, 7:11], as.numeric)

full_sat <- full_sat %>%
  mutate(sat_comp = avg_scr_read + avg_scr_math,
         sat_score = num_tst_takr * sat_comp,
         district_code = substr(cds, 1, 7)) %>% 
  select(1:8, sat_comp, sat_score, district_code, -rtype) %>% 
  drop_na(sat_comp, sat_score)

# merge AP dataset

full_ap <- bind_rows(ap15, ap16, ap17, ap18, .id="year") %>%
  mutate(num_tst = num_scr1 + num_scr2 + num_scr3 + num_scr4 + num_scr5,
         score = num_scr1 * 1 + num_scr2 * 2 + num_scr3 * 3 + num_scr4 * 4 + num_scr5 * 5,
         district_code = substr(cds, 1, 7)) %>% 
  select(1:8, num_tst, score, district_code, -rtype) %>% 
  drop_na(score, num_tst)


# create composite scores by averaging each of the different scores, and create a "score" variable representing total score (to be added and divided at the district level later)

full_act <- bind_rows(act15, act16, act17, act18, .id="year") %>% 
  drop_na(sname, enroll12) %>% 
  mutate(comp = (avg_scr_eng + avg_scr_math + avg_scr_read + avg_scr_sci)/4, 
         score = comp * num_tst_takr,
         district_code = substr(cds, 1, 7)) %>% 
  mutate(test_per = num_tst_takr / enroll12) %>%
  select(1:8, comp, score, test_per, district_code, -rtype)



# district ranks. make sure that there are sufficient test takers (to prevent large outliers). Create a participation rate by dividing num of ACT test takers by 12th grade enrollment. not an meaningful rate by itself (all grades take the test), but it is a proxy for how many students are in a school, and how many take the test. used a percentile rank to avoid minor errors in this methodology

district_act <- full_act %>% 
  drop_na(test_per, comp) %>% 
  group_by(district_code, dname) %>% 
  summarize(act_test_per = mean(num_tst_takr)/mean(enroll12), act_avg_comp = sum(score)/sum(num_tst_takr)) %>%
  ungroup() %>% 
  mutate(act_part_rank = ntile(act_test_per, 100), act_comp_rank = ntile(act_avg_comp, 100))

district_sat <- full_sat %>% 
  group_by(district_code, dname) %>% 
  summarize(sat_test_per = mean(num_tst_takr)/mean(enroll12), sat_avg_comp = sum(sat_score)/sum(num_tst_takr)) %>%
  ungroup() %>% 
  mutate(sat_part_rank = ntile(sat_test_per, 100), sat_comp_rank = ntile(sat_avg_comp, 100))

district_ap <- full_ap %>%
  group_by(district_code, dname) %>% 
  summarize(ap_test_per = mean(num_tst)/mean(enroll1012), ap_avg_score = sum(score)/sum(num_tst)) %>%
  ungroup() %>% 
  mutate(ap_part_rank = ntile(ap_test_per, 100), ap_score_rank = ntile(ap_avg_score, 100))




## expense data. binding 4 year averages of expenses. I wanted to use average daily attendance (current_expense_ada) to come up with a number of dollars spent per pupil according to days attended in school.

full_expense <- bind_rows(expense15, expense16, expense17, expense18, .id="year") %>% 
  filter(! district %in% c("Statewide", "Statewide Totals")) %>%
  filter(lea_type == "Unified") %>% 
  mutate(district_code = paste(co, cds, sep="")) %>% 
  group_by(district_code, district) %>% 
  summarize(d_spend = sum(current_expense_ada)) %>% 
  ungroup() %>% 
  mutate(expense_rank = ntile(desc(d_spend), 100))





district <- full_join(district_sat, district_act, by="district_code") %>% 
  full_join(district_ap, by="district_code")



# merged the two datasets to perform more analysis

district <- district %>% 
  inner_join(full_expense, by="district_code") %>% 
  select(-'dname.x', -'dname.y', -district)


```

```{r}

index <- district %>% 
  mutate(comp_index = ((sat_comp_rank + act_comp_rank + ap_score_rank) / 3),
         comp_rank = ntile(comp_index, 100),
         part_index = ((sat_part_rank + act_part_rank + ap_part_rank) / 3),
         part_rank = ntile(part_index, 100))
  

full_district_demo <- full_join(index, full_staff, by=c("district_code", "dname" = "district_name")) %>% 
  select(-county_name) %>% 
  drop_na(dname)




# creating tables for later - pick interesting ones

expense <- full_district_demo %>% 
  arrange(expense_rank) %>% 
  head(20)

act_part <- full_district_demo %>% 
  arrange(desc(act_part_rank)) %>% 
  head(5)

sat_part <- full_district_demo %>% 
  arrange(desc(sat_part_rank)) %>% 
  head(5)

ap_part <- full_district_demo %>% 
  arrange(desc(sat_part_rank)) %>% 
  head(5)

act_comp <- full_district_demo %>%
  arrange(desc(act_comp_rank)) %>% 
  head(5)

sat_comp <- full_district_demo %>%
  arrange(desc(sat_comp_rank)) %>% 
  head(5)

ap_comp <- full_district_demo %>%
  arrange(desc(ap_score_rank)) %>% 
  head(5)


# metrics - creating the efficiency ranking, reorganizing for the table



efficiency <- full_district_demo %>% 
  drop_na(sat_avg_comp, act_avg_comp, sat_test_per, act_test_per) %>% 
  mutate(comp_rank = ntile(((sat_avg_comp +  act_avg_comp / 2) +  ap_avg_score)/ 2, 100),
         part_rank = ntile(((sat_test_per +  act_test_per / 2) +  ap_test_per)/ 2, 100)) %>% 
  mutate(efficiency_rank = (4/12) * comp_rank + (3/12) * part_rank + (5/12) * expense_rank) %>% 
  arrange(desc(efficiency_rank)) %>% 
  mutate(act_test_per = act_test_per * 100,
         sat_test_per = sat_test_per * 100,
         ap_test_per = ap_test_per * 100) %>% 
  rename(District = dname, "ACT Participation Rate"=act_test_per,
         "SAT Participation Rate" = sat_test_per,
         "AP Participation Rate" = ap_test_per,
         "Avg. SAT Composite Score" = sat_avg_comp, 
         "Avg. ACT Composite Score" = act_avg_comp,
         "Avg. AP Score" = ap_avg_score,
         "Participation Percentile Rank"=part_rank, 
         "Composite Percentile Rank" = comp_rank, 
         "Per Pupil Spend" = d_spend,
         "Spend Percentile Rank" = expense_rank,
         "Efficiency Index" = efficiency_rank) 


# teacher sal + addtl info

# staffdemo - teacher/student ratio, teachers with advanced degrees, age, years teaching, years_in_district
# frlunch - get free reduced lunch %  and enrollments and district code

most_eff <- efficiency %>% 
  arrange(desc(`Efficiency Index`)) %>% 
  head(3) %>% 
  inner_join(addtl_schools, by="District")

eff_tsal <- most_eff %>% 
  select(District, total, base) %>% 
  melt(id.vars = 'District')

eff_ratio <- most_eff %>% 
  mutate(admin_ratio_per100 = admin * 100 / enrollment,
         admin_teach_per100 = admin * 100 / teacher) %>% 
  select(District, admin_ratio_per100, admin_teach_per100, enrollment) %>% 
  melt(id.vars='District')

eff_adv <- most_eff %>% 
  select(District, bach_per, mast_per, doc_per) %>% 
  melt(id.vars='District') 

eff_frpm <- most_eff %>% 
  select(District, free_rate, frpm_rate) %>% 
  melt(id.vars="District")

eff_addtl <- most_eff %>% 
  select(District, avg_t_age, t_exp, dist_exp) %>% 
  melt(id.vars="District")


eff_tsal %>% 
  ggplot(aes(fill=District,x=variable, y=value)) +
       geom_bar(position="dodge", stat="identity") +
       theme_economist() +
       labs(title="Teacher Salaries of the Most Efficient School Districts", x=NULL)



# poorest schools

# test1 <- full_district_demo %>% 
#   filter(free_rate > .75 & expense_rank < 20)

# test2 <- efficiency %>% 
#   arrange(desc(`Efficiency Index`)) %>% 
#   head(6)

high_pov <- bind_rows(test1, test2, .id="status")



# writing files out

write_rds(expense, "CA_EDUC_Data/expense.rds")
write_rds(part, "CA_EDUC_Data/part.rds")
write_rds(comp, "CA_EDUC_Data/comp.rds")
write_rds(efficiency, "CA_EDUC_Data/efficiency.rds")
```

